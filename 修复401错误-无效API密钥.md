# 🔧 修复 401 错误：无效的 OpenAI API 密钥

## ❌ 错误信息

```
401 Unauthorized
Incorrect API key provided: Please check your API key and try again.
```

这个错误表示您的 `OPENAI_API_KEY` 在 Vercel 中配置了，但是**密钥无效、过期或被撤销**。

## 🔍 问题诊断

### 可能的原因：

1. ✅ **API key 格式错误**
   - 正确的格式：`sk-...`（以 `sk-` 开头）
   - 检查是否有多余的空格或换行符

2. ✅ **API key 已过期或被撤销**
   - 在 OpenAI 平台中可能已被删除
   - 需要创建新的 API key

3. ✅ **API key 配置在错误的环境**
   - 检查是否在正确的环境（Production/Preview/Development）中配置

4. ✅ **API key 权限不足**
   - 确保 API key 有访问 GPT-3.5-turbo 的权限

## 🛠️ 解决步骤

### 步骤 1: 获取新的 OpenAI API Key

1. **访问 OpenAI 平台**
   - 打开：https://platform.openai.com/api-keys
   - 登录您的账户

2. **检查现有密钥**
   - 查看是否有有效的 API key
   - 如果所有密钥都显示为 `sk-...`（隐藏），需要创建新的

3. **创建新的 API Key**
   - 点击 **"Create new secret key"**
   - 输入名称（例如：`life-coach-web-production`）
   - **立即复制** API key（格式：`sk-...`）
   - ⚠️ **重要**：API key 只显示一次，请妥善保存

### 步骤 2: 在 Vercel 中更新 API Key

1. **打开 Vercel 项目**
   - 访问：https://vercel.com/dashboard
   - 选择您的项目：`life-coach-web`

2. **进入环境变量设置**
   - 点击项目名称
   - 点击 **"Settings"** 标签
   - 点击左侧菜单的 **"Environment Variables"**

3. **更新 OPENAI_API_KEY**
   - 找到 `OPENAI_API_KEY` 环境变量
   - 点击 **"Edit"** 或 **"Delete"** 后重新添加
   - **Key**: `OPENAI_API_KEY`
   - **Value**: 粘贴您的新 API key（格式：`sk-...`）
   - **Environment**: 选择所有环境（Production、Preview、Development）

4. **保存并重新部署**
   - 点击 **"Save"**
   - 点击 **"Deployments"** 标签
   - 点击最新部署右侧的 **"..."** 菜单
   - 选择 **"Redeploy"**
   - 或者推送一个空提交来触发重新部署：
     ```bash
     git commit --allow-empty -m "Trigger redeploy after updating API key"
     git push
     ```

### 步骤 3: 验证修复

1. **等待部署完成**
   - 在 Vercel 部署页面查看状态
   - 等待状态变为 **"Ready"**（绿色）

2. **测试 API**
   - 运行诊断工具：
     ```bash
     npm run diagnose
     ```
   - 或运行 API 测试：
     ```bash
     npm run test:api
     ```

3. **测试网站功能**
   - 访问您的网站
   - 尝试使用八字命理或其他功能
   - 检查是否还有 401 错误

## 📋 检查清单

在更新 API key 后，请确认：

- [ ] ✅ 新 API key 格式正确（以 `sk-` 开头）
- [ ] ✅ 在 Vercel 中已更新 `OPENAI_API_KEY` 环境变量
- [ ] ✅ 环境变量已应用到所有环境（Production、Preview、Development）
- [ ] ✅ 已触发重新部署
- [ ] ✅ 部署状态为 "Ready"（绿色）
- [ ] ✅ 测试 API 返回成功（不再有 401 错误）
- [ ] ✅ 网站功能正常工作

## 🔐 API Key 安全提示

1. **不要分享 API key**
   - 永远不要在代码中硬编码 API key
   - 不要在 GitHub 等公开仓库中提交 API key

2. **定期轮换 API key**
   - 如果怀疑密钥泄露，立即撤销并创建新的

3. **使用环境变量**
   - ✅ 正确：在 Vercel 环境变量中配置
   - ❌ 错误：在代码中直接写入 API key

4. **设置使用限制**
   - 在 OpenAI 平台中可以为 API key 设置使用限制
   - 监控 API 使用情况，防止异常使用

## 🆘 仍然无法解决？

如果按照以上步骤操作后仍然出现 401 错误，请检查：

1. **OpenAI 账户状态**
   - 登录：https://platform.openai.com/account
   - 检查账户是否有足够的余额
   - 检查账户是否被限制

2. **API key 权限**
   - 确保 API key 有访问 GPT-3.5-turbo 的权限
   - 检查是否有组织级别的限制

3. **Vercel 部署日志**
   - 在 Vercel 中查看 Function Logs
   - 检查是否有其他错误信息

4. **联系支持**
   - OpenAI 支持：https://help.openai.com/
   - Vercel 支持：https://vercel.com/support

## 📝 快速修复命令

```bash
# 1. 测试当前 API 状态
npm run diagnose

# 2. 如果 API key 无效，在 Vercel 中更新后：
# 触发重新部署
git commit --allow-empty -m "Redeploy after API key update"
git push

# 3. 等待部署完成后再次测试
npm run test:api
```

---

**重要提示**：401 错误通常意味着 API key 本身有问题，而不是代码问题。请确保使用**有效且未过期**的 OpenAI API key。

