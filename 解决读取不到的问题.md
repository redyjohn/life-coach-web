# 🔧 解决"读取不到"的问题

## 问题症状

网站已部署，但无法读取 GPT 数据，通常表现为：
- API 返回 500 错误
- 显示 "OpenAI API 金鑰未配置"
- `hasOpenAIKey: false`

## 🔍 快速诊断

运行诊断工具：

```bash
npm run diagnose
```

这会自动检查：
1. 健康检查端点
2. GPT API 配置
3. 环境变量状态

## ✅ 解决方案（3步）

### 步骤 1: 检查环境变量配置

1. **访问 Vercel Dashboard**
   - https://vercel.com/redyjohns-projects/life-coach-web/settings/environment-variables

2. **检查环境变量**
   - 确认 `OPENAI_API_KEY` 存在
   - 点击眼睛图标查看值（应该显示 `sk-proj-...` 或类似格式）
   - 确认选择了所有环境：
     - ☑️ Production
     - ☑️ Preview  
     - ☑️ Development

3. **如果不存在，添加环境变量**
   - 点击 "Add New"
   - Key: `OPENAI_API_KEY`
   - Value: `sk-...`（您的 OpenAI API Key）
   - Environment: 全部勾选
   - 点击 "Save"

### 步骤 2: 重新部署（必须！）

⚠️ **重要**：添加或修改环境变量后，**必须重新部署**才会生效！

**方法 1: 在 Dashboard 重新部署（推荐）**

1. 访问：https://vercel.com/redyjohns-projects/life-coach-web/deployments
2. 找到最新的部署记录
3. 点击右侧的 **"..."** 菜单
4. 选择 **"Redeploy"**
5. 确认重新部署
6. 等待部署完成（状态变为 "Ready"）

**方法 2: 推送空提交触发部署**

```bash
git commit --allow-empty -m "Trigger redeploy"
git push origin main
```

### 步骤 3: 验证配置

部署完成后，运行测试：

```bash
npm run test:api
```

或使用诊断工具：

```bash
npm run diagnose
```

**预期结果：**
- ✅ `hasOpenAIKey: true`
- ✅ GPT API (POST) 测试通过
- ✅ 能够正常获取 AI 回复

## 🔍 常见问题排查

### 问题 1: 环境变量已添加，但还是读取不到

**可能原因：**
1. **没有重新部署**（最常见）
   - 解决：重新部署项目

2. **环境变量作用域不正确**
   - 检查是否选择了 Production 环境
   - 解决：确保勾选所有环境

3. **环境变量名称错误**
   - 检查是否为 `OPENAI_API_KEY`（完全匹配，区分大小写）
   - 解决：确认名称正确

4. **API Key 值错误**
   - 检查是否以 `sk-` 开头
   - 解决：重新创建 API Key 并更新

### 问题 2: 重新部署后还是不行

**检查清单：**

1. **确认部署完成**
   - 在 Deployments 页面查看状态
   - 应该显示 "Ready"（绿色）

2. **查看部署日志**
   - 点击部署记录
   - 查看 Build Logs
   - 确认没有错误

3. **查看函数日志**
   - Functions → `api/gpt` → Logs
   - 查看最新的请求日志
   - 应该看到 `hasOpenAIKey: true`

4. **测试健康检查**
   ```bash
   curl https://life-coach-web.vercel.app/api/health
   ```
   应该返回 `"hasOpenAIKey": true`

### 问题 3: 部分请求成功，部分失败

**可能原因：**
- 环境变量只配置了部分环境（如只配置了 Preview）
- 解决：确保所有环境都配置了

### 问题 4: 本地测试正常，生产环境不行

**检查：**
- 本地使用的是 `.env` 文件
- 生产环境需要使用 Vercel 环境变量
- 解决：在 Vercel Dashboard 配置环境变量

## 📋 完整检查清单

完成以下所有步骤：

- [ ] 已获取 OpenAI API Key
- [ ] 已在 Vercel 添加 `OPENAI_API_KEY` 环境变量
- [ ] 环境变量值正确（以 `sk-` 开头）
- [ ] 已选择所有环境（Production, Preview, Development）
- [ ] **已重新部署项目**
- [ ] 部署已完成（状态为 "Ready"）
- [ ] 健康检查返回 `hasOpenAIKey: true`
- [ ] GPT API (POST) 测试通过
- [ ] 网站功能正常

## 🛠️ 诊断工具

### 使用诊断脚本

```bash
# 运行完整诊断
npm run diagnose
```

诊断脚本会：
- ✅ 检查所有 API 端点
- ✅ 验证环境变量配置
- ✅ 提供详细的解决方案
- ✅ 显示具体的修复步骤

### 手动测试

```bash
# 测试健康检查
curl https://life-coach-web.vercel.app/api/health

# 测试 GPT API
curl -X POST https://life-coach-web.vercel.app/api/gpt \
  -H "Content-Type: application/json" \
  -d '{"prompt": "测试"}'
```

## 📊 验证步骤

### 1. 检查环境变量

访问：
https://vercel.com/redyjohns-projects/life-coach-web/settings/environment-variables

确认：
- `OPENAI_API_KEY` 存在
- 值正确（点击眼睛图标查看）
- 所有环境都已选择

### 2. 检查部署状态

访问：
https://vercel.com/redyjohns-projects/life-coach-web/deployments

确认：
- 最新部署状态为 "Ready"
- 部署时间在添加环境变量之后

### 3. 检查函数日志

访问：
https://vercel.com/redyjohns-projects/life-coach-web

Functions → `api/gpt` → Logs

查看：
- 是否有 `hasOpenAIKey: true` 的日志
- 是否有错误日志

### 4. 运行测试

```bash
npm run test:api
```

或

```bash
npm run diagnose
```

## 🆘 仍然无法解决？

如果按照以上步骤操作后仍然无法解决：

1. **查看详细日志**
   - Vercel Dashboard → Functions → Logs
   - 复制最新的错误日志

2. **检查 OpenAI 账户**
   - 确认 API Key 有效
   - 确认账户有足够额度
   - 访问：https://platform.openai.com/api-keys

3. **联系支持**
   - 提供 Vercel 函数日志
   - 提供诊断脚本输出
   - 说明已完成的步骤

---

**重要提示**：
- 环境变量修改后**必须重新部署**
- 部署通常需要 1-2 分钟
- 使用诊断工具可以快速定位问题

